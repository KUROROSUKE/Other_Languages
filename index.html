<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi-language PDF Preview</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#121821; --muted:#9fb0c3; --text:#e8eef6; --primary:#3aa0ff; --primary-2:#2a7bd1; }
    *{ box-sizing:border-box; margin:0; padding:0; }

    html, body{
      height:100%; width:100%; overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Noto Sans", sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column;
    }

    header{
      flex:0 0 auto; padding:10px 16px; background:var(--panel); border-bottom:1px solid #1b2a3f;
      display:flex; justify-content:center; align-items:center;
    }
    select{
      appearance:none; background:#0d141e; border:1px solid #24344d; border-radius:8px; color:#e8eef6;
      font-size:14px; padding:6px 10px; width:240px;
      text-align:left; text-align-last:left; direction:ltr;
    }

    /* ETA row */
    .eta{
      flex:0 0 auto; display:flex; align-items:center; gap:10px;
      padding:8px 16px; background:#0d141e; border-bottom:1px solid #1b2a3f;
    }
    .bar{ position:relative; flex:1; height:10px; background:#203046; border-radius:999px; overflow:hidden }
    .fill{ position:absolute; inset:0 auto 0 0; width:0%; background:#3aa0ff; transition:width .2s linear }
    .indet{
      background:linear-gradient(90deg, transparent 0%, #3aa0ff 50%, transparent 100%);
      background-size:200% 100%;
      animation: move 1.2s linear infinite;
      width:40%;
    }
    @keyframes move{ from{ transform:translateX(-50%) } to{ transform:translateX(150%) } }
    .etatext{ width:160px; text-align:right; color:var(--muted); font-variant-numeric:tabular-nums; font-size:12px }
    .eta[hidden]{ display:none }

    main{ flex:1 1 auto; display:flex; flex-direction:column; min-height:0; }
    iframe{ flex:1; width:100%; height:100%; border:0; background:#0b111a; display:block; }

    footer{
      flex:0 0 auto; padding:10px 16px; background:var(--panel); border-top:1px solid #1b2a3f;
      font-size:13px; color:var(--muted);
    }

    .error{
      display:none; color:#ffd1d1; background:#471c1c;
      border:1px solid #7a2b2b; padding:8px 10px; font-size:13px; margin:8px 16px; flex:0 0 auto;
    }

    @media (max-width:520px){ select{ width:180px; } }
  </style>
</head>
<body>
  <header>
    <select id="lang_selection">
      <option value="en" selected>🇺🇸 English</option>
      <option value="ja">🇯🇵 日本語</option>
      <option value="de">🇩🇪 Deutsch</option>
      <option value="fr">🇫🇷 Français</option>
      <option value="es">🇪🇸 Español</option>
      <option value="pt">🇵🇹 Português</option>
      <option value="it">🇮🇹 Italiano</option>
      <option value="ru">🇷🇺 Русский</option>
      <option value="ar">🇸🇦 العربية</option>
      <option value="hi">🇮🇳 हिन्दी</option>
      <option value="zh-CN">🇨🇳 简体中文</option>
      <option value="zh-TW">🇹🇼 繁體中文</option>
      <option value="ko">🇰🇷 한국어</option>
    </select>
  </header>

  <!-- 進捗バー + 残り時間 -->
  <div id="etaRow" class="eta" hidden>
    <div class="bar"><div id="etaFill" class="fill"></div></div>
    <div id="etaText" class="etatext">—</div>
  </div>

  <main>
    <iframe id="preview" title="PDF Preview" referrerpolicy="no-referrer"></iframe>
    <div id="errorBox" class="error">Load failed. Check URL or file existence.</div>
  </main>

  <footer id="statusText">No file loaded</footer>

  <script>
    const BASE_URL = "https://kurorosuke.github.io/Other_Languages/pdf";
    const PREVIEW_ID = "preview";
    const STATUS_ID = "statusText";
    const ERROR_ID = "errorBox";
    const SELECT_ID = "lang_selection";
    const ETA_ROW_ID = "etaRow";
    const ETA_FILL_ID = "etaFill";
    const ETA_TEXT_ID = "etaText";

    const I18N = {
      en: { idle:"No file loaded", loading:"Loading…", showing:(l,t)=>`Showing ${l}.pdf${t?` • ${t}s`:''}`, fail:"Load failed.", title:"PDF Preview", eta:"ETA" },
      ja: { idle:"ファイル未読み込み", loading:"読み込み中…", showing:(l,t)=>`表示中 ${l}.pdf${t?` ・${t}秒`:''}`, fail:"読み込みに失敗しました", title:"PDFプレビュー", eta:"残り" },
      de: { idle:"Keine Datei geladen", loading:"Laden…", showing:(l,t)=>`Wird angezeigt: ${l}.pdf${t?` • ${t}s`:''}`, fail:"Laden fehlgeschlagen.", title:"PDF-Vorschau", eta:"Rest" },
      fr: { idle:"Aucun fichier chargé", loading:"Chargement…", showing:(l,t)=>`Affichage : ${l}.pdf${t?` • ${t}s`:''}`, fail:"Échec du chargement.", title:"Aperçu PDF", eta:"Reste" },
      es: { idle:"Ningún archivo cargado", loading:"Cargando…", showing:(l,t)=>`Mostrando: ${l}.pdf${t?` • ${t}s`:''}`, fail:"Error de carga.", title:"Vista previa PDF", eta:"Faltan" },
      pt: { idle:"Nenhum arquivo carregado", loading:"Carregando…", showing:(l,t)=>`Exibindo: ${l}.pdf${t?` • ${t}s`:''}`, fail:"Falha ao carregar.", title:"Pré-visualização PDF", eta:"Restante" },
      it: { idle:"Nessun file caricato", loading:"Caricamento…", showing:(l,t)=>`In visualizzazione: ${l}.pdf${t?` • ${t}s`:''}`, fail:"Caricamento non riuscito.", title:"Anteprima PDF", eta:"Rimanente" },
      ru: { idle:"Файл не загружен", loading:"Загрузка…", showing:(l,t)=>`Отображается: ${l}.pdf${t?` • ${t}с`:''}`, fail:"Не удалось загрузить.", title:"Предпросмотр PDF", eta:"Осталось" },
      ar: { idle:"لا ملف محمّل", loading:"جارٍ التحميل…", showing:(l,t)=>`يُعرض: ‎${l}.pdf${t?` • ${t}ث`:''}`, fail:"فشل التحميل.", title:"معاينة PDF", eta:"المتبقي" },
      hi: { idle:"कोई फ़ाइल लोड नहीं", loading:"लोड हो रहा है…", showing:(l,t)=>`दिखा रहा है: ${l}.pdf${t?` • ${t}सेकंड`:''}`, fail:"लोड विफल।", title:"PDF पूर्वावलोकन", eta:"शेष" },
      "zh-CN": { idle:"未加载文件", loading:"正在加载…", showing:(l,t)=>`正在显示：${l}.pdf${t?` • ${t}秒`:''}`, fail:"加载失败。", title:"PDF 预览", eta:"剩余" },
      "zh-TW": { idle:"未載入檔案", loading:"載入中…", showing:(l,t)=>`顯示中：${l}.pdf${t?` • ${t}秒`:''}`, fail:"載入失敗。", title:"PDF 預覽", eta:"剩餘" },
      ko: { idle:"파일 미로드", loading:"불러오는 중…", showing:(l,t)=>`표시 중: ${l}.pdf${t?` • ${t}초`:''}`, fail:"로드 실패.", title:"PDF 미리보기", eta:"남음" },
    };

    document.getElementById(SELECT_ID).addEventListener("change", () => {
      handlePreview(getSelectedLang());
    });
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById(SELECT_ID).value = "en";
      handlePreview("en");
    });

    function getSelectedLang(){ return document.getElementById(SELECT_ID).value; }
    function buildUrl(lang){ return `${BASE_URL}/${lang}.pdf`; }
    function buildPreviewUrl(lang){
      const pdf = buildUrl(lang);
      if (isIOS() || isAndroid()){
        return `https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(pdf)}`;
      }
      return pdf;
    }

    // ------- ETA ------- //
    let etaAbort = null;
    function startEta(url){
      const row  = document.getElementById(ETA_ROW_ID);
      const fill = document.getElementById(ETA_FILL_ID);
      const txt  = document.getElementById(ETA_TEXT_ID);
      row.hidden = false;
      fill.classList.remove('indet');
      fill.style.width = "0%";
      txt.textContent = `${getMsg('eta')}: …`;

      etaAbort = new AbortController();
      const started = performance.now();
      let loaded = 0, total = 0;

      fetch(url, { signal: etaAbort.signal, cache:"no-store" })
        .then(res => {
          if(!res.ok) throw new Error("fetch");
          total = Number(res.headers.get('Content-Length')) || 0;

          if(!res.body || !('getReader' in res.body) || total === 0){
            // ストリーム不可 or サイズ不明 → 不確定アニメーション
            fill.classList.add('indet');
            txt.textContent = `${getMsg('eta')}: …`;
            return;
          }

          const rdr = res.body.getReader();
          const pump = () => rdr.read().then(({done, value})=>{
            if(done){
              fill.style.width = "100%";
              txt.textContent = `${getMsg('eta')}: 0s`;
              return;
            }
            loaded += value.byteLength;
            const dt = (performance.now() - started)/1000; // s
            const speed = loaded / Math.max(dt, 0.001);     // B/s
            const remain = Math.max(total - loaded, 0);
            const eta = remain / Math.max(speed, 1);        // s
            const pct = Math.min(100, Math.round(loaded/total*100));
            fill.style.width = pct + "%";
            txt.textContent = `${getMsg('eta')}: ${formatEta(eta)}`;
            return pump();
          });
          return pump();
        })
        .catch(()=>{ /* ネットワーク失敗時は非表示にしない。onloadで止める */ });
    }
    function stopEta(){
      if(etaAbort){ try{ etaAbort.abort(); }catch{} etaAbort = null; }
      const row  = document.getElementById(ETA_ROW_ID);
      row.hidden = true;
      const fill = document.getElementById(ETA_FILL_ID);
      fill.classList.remove('indet');
      fill.style.width = "0%";
    }
    function formatEta(sec){
      if(!isFinite(sec) || sec <= 0) return "0s";
      if(sec < 60) return `${Math.ceil(sec)}s`;
      const m = Math.floor(sec/60), s = Math.ceil(sec%60);
      return `${m}m ${s}s`;
    }

    // ------- Preview flow ------- //
    function handlePreview(lang){
      clearError();
      const pdfUrl  = buildUrl(lang);
      const viewUrl = buildPreviewUrl(lang);
      const iframe  = document.getElementById(PREVIEW_ID);

      setStatus(getMsg("loading"));

      // ETA開始（PDF本体を並行計測）
      startEta(pdfUrl);

      const t0 = performance.now();
      const onLoaded = () => {
        const dur = ((performance.now()-t0)/1000).toFixed(1);
        setStatus(getMsg("showing")(lang, dur));
        stopEta();
        iframe.removeEventListener("load", onLoaded);
      };
      iframe.addEventListener("load", onLoaded);

      // 読み込み開始
      iframe.src = `${viewUrl}${viewUrl.includes("?") ? "&" : "?"}v=${Date.now().toString(36)}`;
      iframe.title = getMsg("title");
    }

    // ------- UI helpers ------- //
    function getMsg(key){
      const lang = getSelectedLang();
      return (I18N[lang] || I18N.en)[key] || I18N.en[key];
    }
    function setStatus(text){ document.getElementById(STATUS_ID).textContent = text; }
    function clearError(){ document.getElementById(ERROR_ID).style.display="none"; }

    // ------- UA ------- //
    function isIOS(){
      const ua = navigator.userAgent || navigator.vendor || "";
      const iOS = /iPad|iPhone|iPod/.test(ua);
      const iPadOS13Plus = (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
      return iOS || iPadOS13Plus;
    }
    function isAndroid(){
      const ua = navigator.userAgent || navigator.vendor || "";
      return /Android/i.test(ua);
    }
  </script>
</body>
</html>
