<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Language</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Brochure of Teramachi temples in some Languages." />
  <style>
    :root { --gap:12px; --radius:14px; --pad:14px; --hi:#f0f7ff; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, Arial, sans-serif; margin:16px; }
    /* 確認カード */
    .card { border:1px solid #e2e2e2; border-radius:12px; padding:20px; max-width:420px; margin:18vh auto 0; text-align:center; }
    .q { font-size:1.05rem; margin:0 0 12px; }
    .btns { display:flex; gap:12px; justify-content:center; }
    .btn { padding:10px 16px; border-radius:10px; border:1px solid #d0d0d0; background:#fff; cursor:pointer; font:inherit; }
    .btn.primary { background:#111; color:#fff; border-color:#111; }
    /* 手動選択UI */
    header { margin:0 0 12px; }
    h1 { font-size:1.1rem; margin:0; }
    .grid { display:grid; grid-template-columns:1fr; gap:var(--gap); max-height:calc(100vh - 80px); overflow-y:auto; padding:2px; }
    @media (min-width:640px){ .grid{ grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); max-height:none; } }
    .lang { display:flex; align-items:center; justify-content:space-between; padding:var(--pad); border:1px solid #e2e2e2; border-radius:var(--radius); background:#fff; text-decoration:none; color:inherit; min-height:56px; }
    .lang.highlight { background:var(--hi); border-color:#b6d7ff; }
    .lang:focus { outline:2px solid #111; outline-offset:2px; }
    .name { font-size:1rem; }
    .right { display:flex; gap:8px; align-items:center; }
    .badge { font-size:.7rem; color:#1a1a1a; background:#e9eef5; border-radius:999px; padding:2px 8px; }
    .flag { width:22px; height:16px; border:1px solid #ddd; border-radius:2px; object-fit:cover; display:none; }
    .flag.show { display:inline-block; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <!-- 自動確認画面 -->
  <div id="confirm" class="card hidden" role="dialog" aria-modal="true">
    <p id="q" class="q">この言語で表示しますか？</p>
    <div class="btns">
      <button id="yes" class="btn primary" type="button">はい</button>
      <button id="no" class="btn" type="button">いいえ</button>
    </div>
  </div>

  <!-- 手動選択画面 -->
  <header id="manual-head" class="hidden">
    <h1 id="title">言語を選択</h1>
  </header>
  <nav class="grid hidden" id="lang-grid" aria-label="言語一覧"></nav>

  <script>
    const DEFAULT_FALLBACK = 'en-us';
    const PDF = code => `pdf/${code}.pdf`;
    // 言語ラインナップ（必要に応じて調整しとく。下のやつも変えないとUIはDEFAULT_FALLBACKの言語になる。）
    const LANGS = [
      {code:'en-us', name:'English (US)', cc:'US'},
      {code:'en-gb', name:'English (UK)', cc:'GB'},
      {code:'zh-cn', name:'简体中文', cc:'CN'},
      {code:'zh-tw', name:'繁體中文', cc:'TW'},
      {code:'ja',    name:'日本語',    cc:'JP'},
      {code:'ko',    name:'한국어',    cc:'KR'},
      {code:'de',    name:'Deutsch',  cc:'DE'},
      {code:'fr',    name:'Français', cc:'FR'},
      {code:'es-es', name:'Español (ES)', cc:'ES'},
      {code:'es-mx', name:'Español (MX)', cc:'MX'},
      {code:'pt-br', name:'Português (BR)', cc:'BR'},
      {code:'ru',    name:'Русский',  cc:'RU'},
      {code:'it',    name:'Italiano', cc:'IT'},
    ];
    // ブラウザ標準言語で聞く
    const UI_CONFIRM = {
      'en-us': 'Display in English (US)?',
      'en-gb': 'Display in English (UK)?',
      'zh-cn': '使用简体中文显示？',
      'zh-tw': '使用繁體中文顯示？',
      'ja':    '日本語で表示しますか？',
      'ko':    '한국어로 표시할까요?',
      'de':    'Auf Deutsch anzeigen?',
      'fr':    'Afficher en français ?',
      'es-es': '¿Mostrar en español (ES)?',
      'es-mx': '¿Mostrar en español (MX)?',
      'pt-br': 'Exibir em português (BR)?',
      'ru':    'Показать на русском?',
      'it':    'Mostrare in italiano?'
    };
    const YES_NO = {
      'en-us':{yes:'Yes', no:'No'},
      'en-gb':{yes:'Yes', no:'No'},
      'zh-cn':{yes:'是', no:'否'},
      'zh-tw':{yes:'是', no:'否'},
      'ja':{yes:'はい', no:'いいえ'},
      'ko':{yes:'예', no:'아니오'},
      'de':{yes:'Ja', no:'Nein'},
      'fr':{yes:'Oui', no:'Non'},
      'es-es':{yes:'Sí', no:'No'},
      'es-mx':{yes:'Sí', no:'No'},
      'pt-br':{yes:'Sim', no:'Não'},
      'ru':{yes:'Да', no:'Нет'},
      'it':{yes:'Sì', no:'No'}
    };
    // ?manual=1 のときの一番上。
    const UI_TITLE = {
      'en-us':'Choose your language',
      'en-gb':'Choose your language',
      'zh-cn':'选择语言',
      'zh-tw':'選擇語言',
      'ja':'言語を選択',
      'ko':'언어 선택',
      'de':'Sprache wählen',
      'fr':'Choisissez votre langue',
      'es-es':'Elige tu idioma',
      'es-mx':'Elige tu idioma',
      'pt-br':'Escolha o idioma',
      'ru':'Выберите язык',
      'it':'Scegli la lingua'
    };
    // ?manual=1 のときの「おすすめ」の文字。
    const SUGGESTED = {
      'en-us':'Suggested',
      'en-gb':'Suggested',
      'zh-cn':'推荐',
      'zh-tw':'推薦',
      'ja':'おすすめ',
      'ko':'추천',
      'de':'Empfohlen',
      'fr':'Recommandé',
      'es-es':'Recomendado',
      'es-mx':'Recomendado',
      'pt-br':'Sugerido',
      'ru':'Рекомендуемое',
      'it':'Consigliato'
    };
    const UI_ARIA_LABEL = {
      'en-us': 'Open PDF in a new tab',
      'en-gb': 'Open PDF in a new tab',
      'zh-cn': '在新标签页中打开 PDF',
      'zh-tw': '在新分頁中開啟 PDF',
      'ja':    'PDFを新しいタブで開く',
      'ko':    '새 탭에서 PDF 열기',
      'de':    'PDF in neuem Tab öffnen',
      'fr':    'Ouvrir le PDF dans un nouvel onglet',
      'es-es': 'Abrir el PDF en una nueva pestaña',
      'es-mx': 'Abrir el PDF en una nueva pestaña',
      'pt-br': 'Abrir o PDF em uma nova guia',
      'ru':    'Открыть PDF в новой вкладке',
      'it':    'Apri il PDF in una nuova scheda'
    };


    // 起動
    (function main(){
      const manual = new URLSearchParams(location.search).get('manual') === '1';
      const suggested = suggestLangByDevice(LANGS.map(l=>l.code), DEFAULT_FALLBACK);

      if (!manual) { // ?manual=1 を boolean で検出。ほんとはあんまりよくないかも。
        // 確認ダイアログを検出言語で表示
        showConfirm(suggested);
      } else {
        // 手動選択UI
        document.documentElement.lang = suggested || DEFAULT_FALLBACK;
        applyRtlIfNeeded(suggested); // 右から左の言語に対応
        localizeTitle(suggested); //「言語選択」（タイトル）を訳す
        const ordered = orderCodes(suggested); // 推奨言語を一番上に持ってくる
        buildGrid(ordered, suggested);
        show(byId('manual-head'));
        show(byId('lang-grid'));
        scrollToLang(suggested);
      }
    })();

    // ===== 自動確認 =====
    function showConfirm(code){
      const lang = codeToLang(code) || {name: code, code}; // 言語の正式名称を取得
      const question_title = UI_CONFIRM[code] || UI_CONFIRM[DEFAULT_FALLBACK];
      const yesno = YES_NO[code] || YES_NO[DEFAULT_FALLBACK];
    
      // ページの種類を ja からその国の言語にして、右から左にも対応する
      document.documentElement.lang = lang.code || 'en';
      applyRtlIfNeeded(lang.code);
    
      byId('q').textContent = question_title;
      byId('q').setAttribute('area-label', question_title);
      byId('yes').textContent = yesno.yes;
      byId('no').textContent  = yesno.no;
    
      show(byId('confirm'));
    
      byId('yes').onclick = () => window.location.replace(PDF(lang.code));
      byId('no').onclick  = () => window.location.href = '?manual=1';
    }

    // ===== 手動UI =====
    // 表示する言語の並び替え（?manual=1 のとき）
    function orderCodes(suggested){
      const rest = LANGS.map(l=>l.code).filter(c => c !== suggested);
      return [suggested, ...rest];
    }
    function buildGrid(codes, highlightCode){
      const grid = byId('lang-grid');
      grid.innerHTML = '';
      codes.forEach(code => {
        const l = codeToLang(code);
        const a = document.createElement('a');
        a.href = PDF(l.code);
        a.target = '_blank'; // 手動は新規タブで開く
        a.rel = 'noopener';
        a.className = 'lang' + (code === highlightCode ? ' highlight' : '');
        a.setAttribute('role','button');
        a.setAttribute('aria-label', UI_ARIA_LABEL[code] || UI_ARIA_LABEL[DEFAULT_FALLBACK]);
        a.id = `lang-${l.code}`;

        const left = document.createElement('div');
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = l.name;
        left.appendChild(name);

        const right = document.createElement('div');
        right.className = 'right';

        if (code === highlightCode) {
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = SUGGESTED[highlightCode];
          right.appendChild(badge);
        }

        const img = document.createElement('img');
        img.className = 'flag'; // 本当の意味のflag
        img.alt = '';
        if (l.cc) {
          img.src = `countries_img/${l.cc}.svg`; // 任意で配置。なくても動くからまぁなくてもいい。
          img.onload = () => img.classList.add('show'); // てか重くなるからないほうがいい説まである。
        }
        right.appendChild(img);

        a.appendChild(left);
        a.appendChild(right);
        grid.appendChild(a);
      });
    }

    // ===== 言語推定 =====
    function suggestLangByDevice(catalogCodes, fallback='en-us'){
      const cands = getBrowserLangCandidates();
      for (const c of cands){
        const hit = normalizeToCatalog(catalogCodes, c);
        if (hit) return hit; // null ではないときとも言える。
      }
      return catalogCodes.includes(fallback) ? fallback : catalogCodes[0];
    }
    function getBrowserLangCandidates(){
      const langs = Array.isArray(navigator.languages) && navigator.languages.length // navigator.languages が、利用者の言語一覧
        ? navigator.languages : []; // あるならその配列を代入、ないなら空。
      const lower = langs.map(l => String(l || '').toLowerCase());
      const shorts = lower.map(l => l.split('-')[0]);
      return [...new Set([...lower, ...shorts])];
    }
    function normalizeToCatalog(catalogCodes, lcand){
      const set = new Set(catalogCodes);
      const lc = String(lcand).toLowerCase();
      if (set.has(lc)) return lc;
      const base = lc.split('-')[0];

      if (base === 'en') {
        if (/-gb$/.test(lc) && set.has('en-gb')) return 'en-gb';
        if (/-us$/.test(lc) && set.has('en-us')) return 'en-us';
        if (set.has('en-us')) return 'en-us';
        if (set.has('en-gb')) return 'en-gb';
      }
      if (base === 'zh') {
        if ((/tw|hk|mo/).test(lc) && set.has('zh-tw')) return 'zh-tw';
        if (set.has('zh-cn')) return 'zh-cn';
      }
      if (base === 'es') {
        if ((/mx|419/).test(lc) && set.has('es-mx')) return 'es-mx';
        if (set.has('es-es')) return 'es-es';
      }
      if (base === 'pt') {
        if ((/br/).test(lc) && set.has('pt-br')) return 'pt-br';
        if (set.has('pt-pt')) return 'pt-pt';
      }
      return set.has(base) ? base : null;
    }

    // ===== UIユーティリティ =====
    function localizeTitle(code){
      const t = UI_TITLE[code] || UI_TITLE[DEFAULT_FALLBACK];
      byId('title').textContent = t;
    }
    function applyRtlIfNeeded(code){
      // アラビア語などの右→左言語を追加する場合はここで判定して dir=rtl を適用
      document.documentElement.dir = 'ltr';
      if (code.startsWith('ar')) document.documentElement.dir = 'rtl'; //アラビア語
    }

    // ===== 汎用 =====
    function scrollToLang(code){
      const el = byId(`lang-${code}`);
      if (el) el.scrollIntoView({ block:'center' });
    }
    function byId(id){ return document.getElementById(id); }
    function codeToLang(code){ return LANGS.find(l => l.code === code); }
    function show(el){ el.classList.remove('hidden'); }
  </script>
</body>
