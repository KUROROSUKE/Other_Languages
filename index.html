<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Language Select</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --gap:12px; --btn-h:44px; --radius:12px; }
    body { font-family: system-ui, sans-serif; margin:20px; }
    h1 { font-size:1.25rem; margin:0 0 12px; }
    .hint { color:#555; font-size:.9rem; margin-bottom:16px; }
    .quick { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:var(--gap); margin:0 0 16px; padding:0; list-style:none; }
    .quick button {
      height:var(--btn-h); border:1px solid #ddd; border-radius:var(--radius); background:#fff; cursor:pointer;
      padding:0 12px; text-align:left; font:inherit;
    }
    .quick button:focus { outline:2px solid #222; outline-offset:2px; }
    .row { display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; }
    select, input[type="search"] {
      height:var(--btn-h); padding:0 12px; border:1px solid #ddd; border-radius:var(--radius); font:inherit;
    }
    .row button.open { height:var(--btn-h); padding:0 16px; border:1px solid #111; background:#111; color:#fff; border-radius:var(--radius); cursor:pointer; }
    .small { font-size:.8rem; color:#666; margin-top:8px; }
  </style>
</head>
<body>
  <h1>Choose your language</h1>
  <p class="hint" id="hint">We suggest a language based on your device.</p>

  <ul class="quick" id="quick-list" aria-label="Quick languages"></ul>

  <div class="row" role="group" aria-label="All languages">
    <input type="search" id="lang-search" placeholder="Type to filter…" aria-label="Filter languages">
    <select id="lang-select" aria-label="Language list"></select>
    <button class="open" id="open-btn" type="button">Open PDF</button>
  </div>

  <p class="small" id="remember-note"></p>

  <script>
    // 設定: 言語コードと表示名。display名はネイティブ名を優先。
    const LANGS = [
      {code:'en', name:'English'},
      {code:'ja', name:'日本語'},
      {code:'de', name:'Deutsch'},
      {code:'fr', name:'Français'},
      {code:'es', name:'Español'},
      {code:'it', name:'Italiano'},
      {code:'pt', name:'Português'},
      {code:'ru', name:'Русский'},
      {code:'zh', name:'中文'},
      {code:'ko', name:'한국어'},
      {code:'ar', name:'العربية'},
      {code:'hi', name:'हिन्दी'},
      {code:'tr', name:'Türkçe'},
    ];

    // 入口
    init();

    // 初期化
    function init() {
      const remembered = getRememberedLang();
      const suggested = suggestLangByBrowser();

      buildQuickButtons([remembered || suggested, 'en', 'ja', 'de'].filter(Boolean));
      buildSelect(LANGS);
      wireFilter();
      wireOpen();

      applyInitialSelection(remembered || suggested);
      updateHint(remembered, suggested);
      updateRememberNote(remembered);
      // Enterキーで開く
      document.getElementById('lang-select').addEventListener('keydown', e => {
        if (e.key === 'Enter') openSelected();
      });
      document.getElementById('lang-search').addEventListener('keydown', e => {
        if (e.key === 'Enter') openSelected();
      });
    }

    // ブラウザ言語から候補を返す
    function suggestLangByBrowser() {
      const nav = navigator.languages || [navigator.language || ''];
      const codes = nav.map(v => v.toLowerCase());
      const short = codes.map(v => v.split('-')[0]);
      const all = [...codes, ...short];
      const found = LANGS.find(l => all.includes(l.code));
      return found?.code || null;
    }

    // ローカルストレージから過去選択を取得
    function getRememberedLang() {
      try { return localStorage.getItem('preferred_lang') || null; }
      catch { return null; }
    }

    // クイックボタン群を描画
    function buildQuickButtons(prefList) {
      const unique = uniq(prefList).filter(code => LANGS.some(l => l.code === code));
      const container = document.getElementById('quick-list');
      container.innerHTML = '';
      unique.forEach(code => {
        const lang = LANGS.find(l => l.code === code);
        const li = document.createElement('li');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.setAttribute('aria-label', `${lang.name} PDF`);
        btn.textContent = `${flagEmoji(code)}  ${lang.name}`;
        btn.addEventListener('click', () => openLang(code));
        li.appendChild(btn);
        container.appendChild(li);
      });
    }

    // セレクトを構築
    function buildSelect(list) {
      const sel = document.getElementById('lang-select');
      sel.innerHTML = '';
      list.forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.code;
        opt.textContent = `${l.name} (${l.code})`;
        sel.appendChild(opt);
      });
    }

    // 検索と連動
    function wireFilter() {
      const input = document.getElementById('lang-search');
      const sel = document.getElementById('lang-select');
      input.addEventListener('input', () => {
        const q = input.value.toLowerCase().trim();
        sel.innerHTML = '';
        LANGS.filter(l =>
          l.name.toLowerCase().includes(q) || l.code.toLowerCase().includes(q)
        ).forEach(l => {
          const opt = document.createElement('option');
          opt.value = l.code;
          opt.textContent = `${l.name} (${l.code})`;
          sel.appendChild(opt);
        });
      });
    }

    // 「Open PDF」ボタン
    function wireOpen() {
      document.getElementById('open-btn').addEventListener('click', openSelected);
    }

    // 選択中を開く
    function openSelected() {
      const sel = document.getElementById('lang-select');
      const code = sel.value || LANGS[0].code;
      openLang(code);
    }

    // 指定言語PDFを新規タブで開く
    function openLang(code) {
      const url = `pdf/${code}.pdf`;
      rememberLang(code);
      window.open(url, '_blank', 'noopener');
    }

    // 初期選択反映
    function applyInitialSelection(code) {
      if (!code) return;
      const sel = document.getElementById('lang-select');
      const opt = [...sel.options].find(o => o.value === code);
      if (opt) sel.value = code;
    }

    // 言語記憶
    function rememberLang(code) {
      try { localStorage.setItem('preferred_lang', code); }
      catch {}
      updateRememberNote(code);
    }

    // ヒント文更新
    function updateHint(remembered, suggested) {
      const el = document.getElementById('hint');
      if (remembered) {
        const name = codeToName(remembered);
        el.textContent = `Last time you used ${name}.`;
      } else if (suggested) {
        const name = codeToName(suggested);
        el.textContent = `Suggested: ${name}.`;
      } else {
        el.textContent = 'Select your preferred language.';
      }
    }

    // 記憶表示
    function updateRememberNote(code) {
      const el = document.getElementById('remember-note');
      el.textContent = code ? `Your preference is saved: ${codeToName(code)}.` : '';
    }

    // 補助: ユニーク化
    function uniq(arr) { return [...new Set(arr)]; }

    // 補助: code→名前
    function codeToName(code) { return LANGS.find(l => l.code === code)?.name || code; }

    // 補助: 簡易フラグ（地域コードが無い言語は近似）。問題があれば空文字でも可。
    function flagEmoji(code) {
      const map = {
        en:'GB', ja:'JP', de:'DE', fr:'FR', es:'ES', it:'IT', pt:'PT',
        ru:'RU', zh:'CN', ko:'KR', ar:'SA', hi:'IN', tr:'TR'
      };
      const cc = map[code];
      return cc ? ccToFlag(cc) : '';
    }
    function ccToFlag(cc) {
      return String.fromCodePoint(...cc.toUpperCase().split('').map(c => 0x1F1E6 + (c.charCodeAt(0) - 65)));
    }
  </script>
</body>
</html>
