<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi-language PDF Preview</title>
  <style>
    :root{ --bg:#0b0f14; --panel:#121821; --muted:#9fb0c3; --text:#e8eef6; --primary:#3aa0ff; }
    *{ box-sizing:border-box; margin:0; padding:0; }

    html, body{
      height:100%; width:100%; overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Noto Sans", sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column;
    }

    header{
      flex:0 0 auto; padding:10px 16px; background:var(--panel); border-bottom:1px solid #1b2a3f;
      display:flex; justify-content:center; align-items:center;
    }
    select{
      appearance:none; background:#0d141e; border:1px solid #24344d; border-radius:8px; color:#e8eef6;
      font-size:14px; padding:6px 10px; width:240px;
      text-align:left; text-align-last:left; direction:ltr;
    }

    .eta{
      flex:0 0 auto; display:flex; align-items:center; gap:10px;
      padding:8px 16px; background:#0d141e; border-bottom:1px solid #1b2a3f;
    }
    .bar{ position:relative; flex:1; height:10px; background:#203046; border-radius:999px; overflow:hidden }
    .fill{ position:absolute; inset:0 auto 0 0; width:0%; background:var(--primary); transition:width .2s linear }
    .indet{
      background:linear-gradient(90deg, transparent 0%, var(--primary) 50%, transparent 100%);
      background-size:200% 100%; animation:move 1.2s linear infinite; width:40%;
    }
    @keyframes move{ from{ transform:translateX(-50%) } to{ transform:translateX(150%) } }
    .etatext{ width:160px; text-align:right; color:var(--muted); font-variant-numeric:tabular-nums; font-size:12px }
    .eta[hidden]{ display:none }

    main{ flex:1 1 auto; display:flex; flex-direction:column; min-height:0; }
    iframe{ flex:1; width:100%; height:100%; border:0; background:#0b111a; display:block; }

    footer{
      flex:0 0 auto; padding:10px 16px; background:var(--panel); border-top:1px solid #1b2a3f;
      font-size:13px; color:var(--muted);
    }
  </style>
</head>
<body>
  <header>
    <select id="lang_selection">
      <option value="en" selected>ğŸ‡ºğŸ‡¸ English</option>
      <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
      <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
      <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
      <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
      <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
      <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
      <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
      <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
      <option value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
      <option value="cn">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option>
      <option value="tw">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</option>
      <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
    </select>
  </header>

  <!-- é€²æ—ãƒãƒ¼ + æ®‹ã‚Šæ™‚é–“ -->
  <div id="etaRow" class="eta" hidden>
    <div class="bar"><div id="etaFill" class="fill"></div></div>
    <div id="etaText" class="etatext">â€”</div>
  </div>

  <main>
    <iframe id="preview" title="PDF Preview" referrerpolicy="no-referrer"></iframe>
  </main>

  <footer id="statusText">No file loaded</footer>

  <script>
    const BASE_URL = "https://kurorosuke.github.io/Other_Languages/pdf";
    const PREVIEW_ID = "preview";
    const STATUS_ID = "statusText";
    const SELECT_ID = "lang_selection";
    const ETA_ROW_ID = "etaRow";
    const ETA_FILL_ID = "etaFill";
    const ETA_TEXT_ID = "etaText";

    const I18N = {
      en:{idle:"No file loaded",loading:"Loadingâ€¦",showing:(l,t)=>`Showing ${l}.pdf${t?` â€¢ ${t}s`:''}`,fail:"Load failed. Please try again.",title:"PDF Preview",eta:"ETA"},
      ja:{idle:"ãƒ•ã‚¡ã‚¤ãƒ«æœªèª­ã¿è¾¼ã¿",loading:"èª­ã¿è¾¼ã¿ä¸­â€¦",showing:(l,t)=>`è¡¨ç¤ºä¸­ ${l}.pdf${t?` ãƒ»${t}ç§’`:''}`,fail:"èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",title:"PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼",eta:"æ®‹ã‚Š"},
      de:{idle:"Keine Datei geladen",loading:"Ladenâ€¦",showing:(l,t)=>`Wird angezeigt: ${l}.pdf${t?` â€¢ ${t}s`:''}`,fail:"Laden fehlgeschlagen. Bitte erneut versuchen.",title:"PDF-Vorschau",eta:"Rest"},
      fr:{idle:"Aucun fichier chargÃ©",loading:"Chargementâ€¦",showing:(l,t)=>`Affichage : ${l}.pdf${t?` â€¢ ${t}s`:''}`,fail:"Ã‰chec du chargement. RÃ©essayez.",title:"AperÃ§u PDF",eta:"Reste"},
      es:{idle:"NingÃºn archivo cargado",loading:"Cargandoâ€¦",showing:(l,t)=>`Mostrando: ${l}.pdf${t?` â€¢ ${t}s`:''}`,fail:"Error de carga. IntÃ©ntalo de nuevo.",title:"Vista previa PDF",eta:"Faltan"},
      pt:{idle:"Nenhum arquivo carregado",loading:"Carregandoâ€¦",showing:(l,t)=>`Exibindo: ${l}.pdf${t?` â€¢ ${t}s`:''}`,fail:"Falha ao carregar. Tente novamente.",title:"PrÃ©-visualizaÃ§Ã£o PDF",eta:"Restante"},
      it:{idle:"Nessun file caricato",loading:"Caricamentoâ€¦",showing:(l,t)=>`In visualizzazione: ${l}.pdf${t?` â€¢ ${t}s`:''}`,fail:"Caricamento non riuscito. Riprova.",title:"Anteprima PDF",eta:"Rimanente"},
      ru:{idle:"Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½",loading:"Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦",showing:(l,t)=>`ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ: ${l}.pdf${t?` â€¢ ${t}Ñ`:''}`,fail:"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ. ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºÑƒ.",title:"ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ PDF",eta:"ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ"},
      ar:{idle:"Ù„Ø§ Ù…Ù„Ù Ù…Ø­Ù…Ù‘Ù„",loading:"Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦",showing:(l,t)=>`ÙŠÙØ¹Ø±Ø¶: â€${l}.pdf${t?` â€¢ ${t}Ø«`:''}`,fail:"ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.",title:"Ù…Ø¹Ø§ÙŠÙ†Ø© PDF",eta:"Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ"},
      hi:{idle:"à¤•à¥‹à¤ˆ à¤«à¤¼à¤¾à¤‡à¤² à¤²à¥‹à¤¡ à¤¨à¤¹à¥€à¤‚",loading:"à¤²à¥‹à¤¡ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆâ€¦",showing:(l,t)=>`à¤¦à¤¿à¤–à¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆ: ${l}.pdf${t?` â€¢ ${t}à¤¸à¥‡à¤•à¤‚à¤¡`:''}`,fail:"à¤²à¥‹à¤¡ à¤µà¤¿à¤«à¤²à¥¤ à¤ªà¥à¤¨à¤ƒ à¤ªà¥à¤°à¤¯à¤¾à¤¸ à¤•à¤°à¥‡à¤‚à¥¤",title:"PDF à¤ªà¥‚à¤°à¥à¤µà¤¾à¤µà¤²à¥‹à¤•à¤¨",eta:"à¤¶à¥‡à¤·"},
      cn:{idle:"æœªåŠ è½½æ–‡ä»¶",loading:"æ­£åœ¨åŠ è½½â€¦",showing:(l,t)=>`æ­£åœ¨æ˜¾ç¤ºï¼š${l}.pdf${t?` â€¢ ${t}ç§’`:''}`,fail:"åŠ è½½å¤±è´¥ã€‚è¯·é‡è¯•ã€‚",title:"PDF é¢„è§ˆ",eta:"å‰©ä½™"},
      tw:{idle:"æœªè¼‰å…¥æª”æ¡ˆ",loading:"è¼‰å…¥ä¸­â€¦",showing:(l,t)=>`é¡¯ç¤ºä¸­ï¼š${l}.pdf${t?` â€¢ ${t}ç§’`:''}`,fail:"è¼‰å…¥å¤±æ•—ã€‚è«‹å†è©¦ä¸€æ¬¡ã€‚",title:"PDF é è¦½",eta:"å‰©é¤˜"},
      ko:{idle:"íŒŒì¼ ë¯¸ë¡œë“œ",loading:"ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦",showing:(l,t)=>`í‘œì‹œ ì¤‘: ${l}.pdf${t?` â€¢ ${t}ì´ˆ`:''}`,fail:"ë¡œë“œ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.",title:"PDF ë¯¸ë¦¬ë³´ê¸°",eta:"ë‚¨ìŒ"},
    };

    const RENDER_GRACE_SEC = 2;   // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†â†’æç”»ã¾ã§ã®çŒ¶äºˆç§’
    const MAX_RENDER_RETRY = 3;   // è‡ªå‹•å†è©¦è¡Œå›æ•°

    // ===== setStatus with auto-clear =====
    let __statusTimer = null;
    function setStatus(text, { persist = false, clearAfter = 4000 } = {}) {
      const el = document.getElementById(STATUS_ID);
      el.textContent = text;
      if (__statusTimer) { clearTimeout(__statusTimer); __statusTimer = null; }
      if (!persist) {
        __statusTimer = setTimeout(() => {
          if (el.textContent === text) el.textContent = "";
        }, clearAfter);
      }
    }

    document.getElementById(SELECT_ID).addEventListener("change", () => {
      previewWithAutoRecovery(getSelectedLang());
    });
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById(SELECT_ID).value = "en";
      previewWithAutoRecovery("en");
    });

    function getSelectedLang(){ return document.getElementById(SELECT_ID).value; }
    function buildUrl(lang){ return `${BASE_URL}/${lang}.pdf`; }

    // iOSã¯ viewerng å„ªå…ˆã€Android ã¯ gviewã€PC ã¯ç›´PDF
    function primaryViewer(lang){
      const pdf = buildUrl(lang);
      const gview    = `https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(pdf)}`;
      const viewerng = `https://drive.google.com/viewerng/viewer?embedded=true&url=${encodeURIComponent(pdf)}`;
      if (isIOS()) return viewerng;
      if (isAndroid()) return gview;
      return pdf;
    }
    function fallbackViewer(lang, currentUrl){
      const pdf = buildUrl(lang);
      const gview    = `https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(pdf)}`;
      const viewerng = `https://drive.google.com/viewerng/viewer?embedded=true&url=${encodeURIComponent(pdf)}`;
      const isGview   = currentUrl?.startsWith("https://docs.google.com/gview?");
      const isViewerN = currentUrl?.startsWith("https://drive.google.com/viewerng/");
      if (isGview)   return viewerng; // gviewâ†’viewerng
      if (isViewerN) return pdf;      // viewerngâ†’ç›´PDF
      return gview;                   // ç›´PDFâ†’gview
    }

    // ===== ETA =====
    let etaAbort = null;
    function startEta(url, onComplete){
      const row  = document.getElementById(ETA_ROW_ID);
      const fill = document.getElementById(ETA_FILL_ID);
      const txt  = document.getElementById(ETA_TEXT_ID);
      row.hidden = false; fill.classList.remove('indet'); fill.style.width = "0%";
      txt.textContent = `${getMsg('eta')}: â€¦`;

      etaAbort = new AbortController();
      const started = performance.now();
      let loaded = 0, total = 0;

      fetch(url, { signal: etaAbort.signal, cache:"no-store" })
        .then(res => {
          if(!res.ok) throw new Error("fetch");
          total = Number(res.headers.get('Content-Length')) || 0;

          if(!res.body || !('getReader' in res.body) || total === 0){
            fill.classList.add('indet'); // ã‚µã‚¤ã‚ºä¸æ˜ â†’ ä¸ç¢ºå®šã‚¢ãƒ‹ãƒ¡
            return;
          }

          const rdr = res.body.getReader();
          const pump = () => rdr.read().then(({done,value})=>{
            if(done){
              fill.style.width = "100%";
              txt.textContent = `${getMsg('eta')}: 0s`;
              onComplete && onComplete(); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†é€šçŸ¥
              return;
            }
            loaded += value.byteLength;
            const dt = (performance.now() - started)/1000;
            const speed = loaded / Math.max(dt, 0.001);
            const remain = Math.max(total - loaded, 0);
            const eta = remain / Math.max(speed, 1);
            const pct = Math.min(100, Math.round(loaded/total*100));
            fill.style.width = pct + "%";
            txt.textContent = `${getMsg('eta')}: ${formatEta(eta)}`;
            return pump();
          });
          return pump();
        })
        .catch(()=>{ /* ç„¡è¦–ï¼ˆå†è©¦è¡Œå´ã§å¯¾å¿œï¼‰ */ });
    }
    function stopEta(){
      if(etaAbort){ try{ etaAbort.abort(); }catch{} etaAbort = null; }
      document.getElementById(ETA_ROW_ID).hidden = true;
      const fill = document.getElementById(ETA_FILL_ID);
      fill.classList.remove('indet'); fill.style.width = "0%";
    }
    function formatEta(sec){
      if(!isFinite(sec) || sec <= 0) return "0s";
      if(sec < 60) return `${Math.ceil(sec)}s`;
      const m = Math.floor(sec/60), s = Math.ceil(sec%60);
      return `${m}m ${s}s`;
    }

    // ===== Preview + Auto Recovery =====
    function previewWithAutoRecovery(lang){
      const iframe = document.getElementById(PREVIEW_ID);
      const pdfUrl = buildUrl(lang);
      let viewUrl = primaryViewer(lang);
      let attempt = 0;

      const loadOnce = (changeViewer=false) => new Promise(resolve=>{
        setStatus(getMsg("loading"), { persist:true });
        stopEta();

        let graceTimer = null;
        startEta(pdfUrl, () => {
          graceTimer = setTimeout(()=>{
            resolve({ ok:false, reason:"render-stall" });
          }, RENDER_GRACE_SEC * 1000);
        });

        const t0 = performance.now();
        const onLoad = () => {
          if(graceTimer) clearTimeout(graceTimer);
          const dur = ((performance.now()-t0)/1000).toFixed(1);
          setStatus(getMsg("showing")(lang, dur), { persist:false, clearAfter:4000 });
          stopEta();
          cleanup();
          resolve({ ok:true });
        };
        const onError = () => {
          if(graceTimer) clearTimeout(graceTimer);
          stopEta();
          cleanup();
          resolve({ ok:false, reason:"error" });
        };
        function cleanup(){
          iframe.removeEventListener("load", onLoad);
          iframe.removeEventListener("error", onError);
        }

        iframe.addEventListener("load", onLoad);
        iframe.addEventListener("error", onError);

        if(changeViewer){ viewUrl = fallbackViewer(lang, viewUrl); }

        // iOSã¯ about:blank ã‚’æŒŸã¾ãšã€referrerpolicy ã‚‚å¤–ã™
        const targetUrl = `${viewUrl}${viewUrl.includes("?") ? "&" : "?"}v=${Date.now().toString(36)}`;
        if (isIOS()){
          iframe.removeAttribute('referrerpolicy');
          iframe.src = targetUrl;
          iframe.title = getMsg("title");
        } else {
          iframe.src = "about:blank";
          requestAnimationFrame(()=>{
            iframe.src = targetUrl;
            iframe.title = getMsg("title");
          });
        }
      });

      const run = () => {
        loadOnce(false).then(r=>{
          if(r.ok) return;
          attempt++;
          if(attempt >= MAX_RENDER_RETRY){
            stopEta();
            setStatus(getMsg("fail"), { persist:true });
            return;
          }
          const change = (attempt >= 2);
          setTimeout(()=> runAttempt(change), 500);
        });
      };
      const runAttempt = (changeViewer) => {
        loadOnce(changeViewer).then(r=>{
          if(r.ok) return;
          attempt++;
          if(attempt >= MAX_RENDER_RETRY){
            stopEta();
            setStatus(getMsg("fail"), { persist:true });
            return;
          }
          const nextChange = (attempt >= 2);
          setTimeout(()=> runAttempt(nextChange), 700);
        });
      };

      run();
    }

    // ===== Helpers =====
    function getMsg(key){
      const lang = getSelectedLang();
      return (I18N[lang] || I18N.en)[key] || I18N.en[key];
    }
    function getSelectedLang(){ return document.getElementById(SELECT_ID).value; }

    function isIOS(){
      const ua = navigator.userAgent || navigator.vendor || "";
      const iOS = /iPad|iPhone|iPod/.test(ua);
      const iPadOS13Plus = (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
      return iOS || iPadOS13Plus;
    }
    function isAndroid(){
      const ua = navigator.userAgent || navigator.vendor || "";
      return /Android/i.test(ua);
    }
  </script>
</body>
</html>
