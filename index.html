<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Language Select</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --gap:12px; --radius:14px; --pad:14px; --hi:#f0f7ff; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, Arial, sans-serif; margin:16px; }
    header { margin:0 0 12px; }
    h1 { font-size:1.1rem; margin:0 0 6px; }
    .hint { color:#555; font-size:.9rem; margin:0; }
    .grid {
      display:grid; grid-template-columns:1fr; gap:var(--gap);
      max-height:calc(100vh - 110px); overflow-y:auto; padding:2px; scroll-behavior:smooth;
    }
    @media (min-width:640px){ .grid{ grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); max-height:none; } }
    .lang {
      display:flex; align-items:center; justify-content:space-between;
      padding:var(--pad); border:1px solid #e2e2e2; border-radius:var(--radius);
      background:#fff; cursor:pointer; text-decoration:none; color:inherit; min-height:56px;
    }
    .lang.highlight { background:var(--hi); border-color:#b6d7ff; }
    .lang:focus { outline:2px solid #111; outline-offset:2px; }
    .name { font-size:1rem; }
    .sub { font-size:.8rem; color:#666; }
    .right { display:flex; gap:8px; align-items:center; }
    .badge { font-size:.7rem; color:#1a1a1a; background:#e9eef5; border-radius:999px; padding:2px 8px; }
    .cc { font-size:.75rem; background:#f4f4f4; border-radius:6px; padding:2px 6px; color:#444; }
    .flag { width:22px; height:16px; border:1px solid #ddd; border-radius:2px; object-fit:cover; display:none; }
    .flag.show { display:inline-block; }
  </style>
</head>
<body>
  <header>
    <h1 id="title">言語を選択</h1>
    <p class="hint" id="hint">端末設定に合わせて順番を調整しています。</p>
  </header>

  <nav class="grid" id="lang-grid" aria-label="言語一覧"></nav>

  <script>
    // ===== 設定 =====
    const LANGS = [
      {code:'en', name:'English',    cc:'GB'},
      {code:'ja', name:'日本語',        cc:'JP'},
      {code:'de', name:'Deutsch',    cc:'DE'},
      {code:'fr', name:'Français',   cc:'FR'},
      {code:'es', name:'Español',    cc:'ES'},
      {code:'it', name:'Italiano',   cc:'IT'},
      {code:'pt', name:'Português',  cc:'PT'},
      {code:'ru', name:'Русский',    cc:'RU'},
      {code:'zh', name:'中文',         cc:'CN'},
      {code:'ko', name:'한국어',        cc:'KR'},
      {code:'ar', name:'العربية',      cc:'SA', dir:'rtl'},
      {code:'hi', name:'हिन्दी',       cc:'IN'},
      {code:'tr', name:'Türkçe',     cc:'TR'},
    ];
    const UI_I18N = {
      en:{ title:'Choose your language', hint:'Ordered by your device language.' },
      ja:{ title:'言語を選択', hint:'端末の言語に合わせて順序を最適化しています。' },
      de:{ title:'Sprache wählen', hint:'Nach Ihrer Gerätesprache sortiert.' },
      fr:{ title:'Choisissez votre langue', hint:'Ordonné selon la langue de votre appareil.' },
      es:{ title:'Elige tu idioma', hint:'Ordenado por el idioma del dispositivo.' },
      it:{ title:'Scegli la lingua', hint:'Ordinato in base alla lingua del dispositivo.' },
      pt:{ title:'Escolha o idioma', hint:'Ordenado pelo idioma do dispositivo.' },
      ru:{ title:'Выберите язык', hint:'Отсортировано по языку устройства.' },
      zh:{ title:'选择语言', hint:'根据设备语言排序。' },
      ko:{ title:'언어 선택', hint:'기기 언어 기준으로 정렬합니다.' },
      ar:{ title:'اختر لغتك', hint:'مرتبة حسب لغة جهازك.' },
      hi:{ title:'भाषा चुनें', hint:'डिवाइस भाषा के अनुसार क्रमित।' },
      tr:{ title:'Dilinizi seçin', hint:'Cihaz dilinize göre sıralandı.' },
    };
    const DEFAULT_FALLBACK = 'en';

    // ===== 起動 =====
    init();

    function init(){
      const suggested = suggestLangByDevice(LANGS.map(l=>l.code), null, DEFAULT_FALLBACK);
      applyRtlIfNeeded(suggested);
      localizeUI(suggested);
      const ordered = orderCodes(suggested);
      buildGrid(ordered, suggested);
      // モバイルで推奨位置にスクロール
      scrollToLang(suggested);
    }

    // ===== 並びと描画 =====
    function orderCodes(suggested){
      const rest = LANGS.map(l=>l.code).filter(c => c !== suggested);
      return [suggested, ...rest];
    }

    function buildGrid(codes, highlightCode){
      const grid = byId('lang-grid');
      grid.innerHTML = '';
      codes.forEach(code => {
        const l = codeToLang(code);
        const a = document.createElement('a');
        a.href = `pdf/${l.code}.pdf`;
        a.target = '_blank';
        a.rel = 'noopener';
        a.className = 'lang' + (code === highlightCode ? ' highlight' : '');
        a.setAttribute('role','button');
        a.setAttribute('aria-label', `${l.name} のPDFを新しいタブで開く`);
        a.id = `lang-${l.code}`;

        const left = document.createElement('div');
        const name = document.createElement('div'); name.className = 'name'; name.textContent = l.name;
        const sub  = document.createElement('div'); sub.className = 'sub';  sub.textContent = `(${l.code})`;
        left.appendChild(name); left.appendChild(sub);

        const right = document.createElement('div'); right.className = 'right';
        // 国旗画像（あれば表示）
        const img = document.createElement('img'); img.className = 'flag'; img.alt = '';
        if (l.cc) { // 例: /countries_img/JP.svg を置けば自動で表示
          img.src = `countries_img/${l.cc}.svg`;
          img.onload = () => img.classList.add('show');
        }
        const ccBadge = document.createElement('span'); ccBadge.className = 'cc'; ccBadge.textContent = l.code.toUpperCase();

        // 先頭はおすすめバッジ
        if (code === highlightCode) {
          const badge = document.createElement('span'); badge.className = 'badge'; badge.textContent = 'Suggested';
          right.appendChild(badge);
        }

        right.appendChild(img);
        right.appendChild(ccBadge);

        a.appendChild(left);
        a.appendChild(right);

        grid.appendChild(a);
      });
    }

    // ===== 推定と言語処理 =====
    function suggestLangByDevice(catalogCodes, _ignored, fallback='en'){
      const cands = getBrowserLangCandidates();
      for (const c of cands){
        const hit = normalizeToCatalog(catalogCodes, c);
        if (hit) return hit;
      }
      return catalogCodes.includes(fallback) ? fallback : catalogCodes[0];
    }
    function getBrowserLangCandidates(){
      const langs = Array.isArray(navigator.languages) && navigator.languages.length
        ? navigator.languages : [navigator.language].filter(Boolean);
      const lower = langs.map(l => String(l || '').toLowerCase());
      const shorts = lower.map(l => l.split('-')[0]);
      return [...new Set([...lower, ...shorts])];
    }
    function normalizeToCatalog(catalogCodes, cand){
      const set = new Set(catalogCodes);
      if (set.has(cand)) return cand;
      const base = cand.split('-')[0];
      if (set.has(base)) return base;
      if (base === 'zh') return 'zh';
      if (base === 'pt') return 'pt';
      return null;
    }

    // ===== UIローカライズ・方向 =====
    function localizeUI(code){
      const t = UI_I18N[code] || UI_I18N[DEFAULT_FALLBACK];
      byId('title').textContent = t.title;
      byId('hint').textContent  = t.hint;
    }
    function applyRtlIfNeeded(code){
      const l = codeToLang(code);
      document.documentElement.dir = l && l.dir === 'rtl' ? 'rtl' : 'ltr';
    }

    // ===== 補助 =====
    function scrollToLang(code){
      const el = byId(`lang-${code}`);
      if (el) el.scrollIntoView({ block:'center' });
    }
    function byId(id){ return document.getElementById(id); }
    function codeToLang(code){ return LANGS.find(l => l.code === code); }
  </script>
</body>
</html>
