<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi-language PDF Preview</title>
  <link rel="preconnect" href="https://kurorosuke.github.io" />
  <style>
    :root{ --bg:#0b0f14; --panel:#121821; --muted:#9fb0c3; --text:#e8eef6; --primary:#3aa0ff; --primary-2:#2a7bd1; }
    *{ box-sizing:border-box }
    body{
      margin:0; padding:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Noto Sans", sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; height:100vh;
    }
    header{
      padding:10px 16px; background:var(--panel);
      display:flex; gap:10px; align-items:center;
      border-bottom:1px solid #1b2a3f;
    }
    label{ font-size:14px; color:var(--muted) }
    select{
      appearance:none; background:#0d141e; border:1px solid #24344d;
      border-radius:8px; color:var(--text);
      font-size:14px; padding:6px 10px; min-width:180px;
    }
    button{
      appearance:none; border:none; cursor:pointer;
      padding:7px 14px; border-radius:8px;
      font-weight:600; font-size:14px;
      background:var(--primary); color:#07131f;
      transition:.15s background;
    }
    button:hover{ background:var(--primary-2); }
    .status{ margin-left:auto; font-size:13px; color:var(--muted) }
    main{ flex:1; display:flex; flex-direction:column }
    iframe{ flex:1; width:100%; border:0; background:#0b111a }
    .error{
      display:none; color:#ffd1d1; background:#471c1c;
      border:1px solid #7a2b2b; padding:8px 10px; font-size:13px; margin:8px 16px;
    }
    .progress-wrap{ padding:8px 16px; display:none; gap:8px; align-items:center }
    .bar{ position:relative; flex:1; height:10px; background:#203046; border-radius:999px; overflow:hidden }
    .fill{ position:absolute; left:0; top:0; height:100%; width:0%; background:#3aa0ff; }
    .pct{ width:56px; text-align:right; font-variant-numeric:tabular-nums; color:var(--muted); font-size:12px }
    .hint{ color:var(--muted); font-size:12px; margin:4px 16px }
    .actions{ padding:0 16px 8px 16px; display:flex; gap:8px }
    .btn-ghost{ background:#0d141e; color:var(--text); border:1px solid #22334c }
  </style>
</head>
<body>
  <header>
    <label id="label-lang" for="lang_selection">Language</label>
    <select id="lang_selection">
      <option value="en" selected>ğŸ‡ºğŸ‡¸ English</option>
      <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
      <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
      <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
      <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
      <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
      <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
      <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
      <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
      <option value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
      <option value="zh-CN">ğŸ‡¨ğŸ‡³ ç®€ä½“ä¸­æ–‡</option>
      <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡</option>
      <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
    </select>
    <button id="preview-btn">Preview</button>
    <div id="statusText" class="status">No file loaded</div>
  </header>

  <main>
    <div class="progress-wrap" id="progressWrap" aria-live="polite">
      <div class="bar"><div class="fill" id="fill"></div></div>
      <div class="pct" id="pct">0%</div>
    </div>
    <div class="actions">
      <button id="cancel-btn" class="btn-ghost" style="display:none">Cancel</button>
      <button id="retry-btn" class="btn-ghost" style="display:none">Retry</button>
    </div>
    <div class="hint" id="hint" style="display:none">Rendering can take time on iPad. Keep the tab in foreground.</div>

    <iframe id="preview" title="PDF Preview" referrerpolicy="no-referrer"></iframe>
    <div id="errorBox" class="error">Load failed. Check URL or file existence.</div>
  </main>

  <script>
    // ===== constants =====
    const SELECT_ID = "lang_selection";
    const PREVIEW_ID = "preview";
    const STATUS_ID = "statusText";
    const ERROR_ID = "errorBox";
    const LABEL_LANG_ID = "label-lang";
    const PREVIEW_BTN_ID = "preview-btn";
    const CANCEL_ID = "cancel-btn";
    const RETRY_ID  = "retry-btn";
    const PROG_WRAP_ID = "progressWrap";
    const FILL_ID = "fill";
    const PCT_ID  = "pct";
    const HINT_ID = "hint";
    const BASE_URL = "https://kurorosuke.github.io/Other_Languages/pdf";

    // i18n
    const I18N = {
      "en": { lang:"Language", preview:"Preview", idle:"No file loaded", loading:"Loadingâ€¦", showing:(l)=>`Showing: ${l}.pdf`, fail:"Load failed. Check URL or file existence.", title:"PDF Preview", cancel:"Cancel", retry:"Retry", hint:"Rendering can take time on iPad. Keep the tab in foreground." },
      "ja": { lang:"è¨€èª", preview:"ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼", idle:"ãƒ•ã‚¡ã‚¤ãƒ«æœªèª­ã¿è¾¼ã¿", loading:"èª­ã¿è¾¼ã¿ä¸­â€¦", showing:(l)=>`è¡¨ç¤ºä¸­: ${l}.pdf`, fail:"èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URL ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", title:"PDF ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼", cancel:"ä¸­æ­¢", retry:"å†è©¦è¡Œ", hint:"iPad ã§ã¯æç”»ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã‚¿ãƒ–ã‚’å‰é¢ã«ã—ã¦ãã ã•ã„ã€‚" },
      "de": { lang:"Sprache", preview:"Vorschau", idle:"Keine Datei geladen", loading:"Ladenâ€¦", showing:(l)=>`Wird angezeigt: ${l}.pdf`, fail:"Laden fehlgeschlagen. URL prÃ¼fen.", title:"PDF-Vorschau", cancel:"Abbrechen", retry:"Erneut", hint:"Auf iPad kann das Rendern dauern. Tab im Vordergrund halten." },
      "fr": { lang:"Langue", preview:"AperÃ§u", idle:"Aucun fichier chargÃ©", loading:"Chargementâ€¦", showing:(l)=>`Affichage : ${l}.pdf`, fail:"Ã‰chec du chargement. VÃ©rifiez lâ€™URL.", title:"AperÃ§u PDF", cancel:"Annuler", retry:"RÃ©essayer", hint:"Le rendu peut Ãªtre lent sur iPad. Gardez lâ€™onglet au premier plan." },
      "es": { lang:"Idioma", preview:"Vista previa", idle:"NingÃºn archivo cargado", loading:"Cargandoâ€¦", showing:(l)=>`Mostrando: ${l}.pdf`, fail:"Error de carga. Verifique la URL.", title:"Vista previa de PDF", cancel:"Cancelar", retry:"Reintentar", hint:"El renderizado puede tardar en iPad. MantÃ©n la pestaÃ±a en primer plano." },
      "pt": { lang:"Idioma", preview:"PrÃ©via", idle:"Nenhum arquivo carregado", loading:"Carregandoâ€¦", showing:(l)=>`Exibindo: ${l}.pdf`, fail:"Falha ao carregar. Verifique a URL.", title:"PrÃ©-visualizaÃ§Ã£o de PDF", cancel:"Cancelar", retry:"Tentar novamente", hint:"Em iPad o render pode demorar. Mantenha a aba em primeiro plano." },
      "it": { lang:"Lingua", preview:"Anteprima", idle:"Nessun file caricato", loading:"Caricamentoâ€¦", showing:(l)=>`In visualizzazione: ${l}.pdf`, fail:"Caricamento non riuscito. Verifica lâ€™URL.", title:"Anteprima PDF", cancel:"Annulla", retry:"Riprova", hint:"Su iPad il rendering puÃ² richiedere tempo. Mantieni la scheda in primo piano." },
      "ru": { lang:"Ğ¯Ğ·Ñ‹Ğº", preview:"ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€", idle:"Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½", loading:"Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°â€¦", showing:(l)=>`ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ: ${l}.pdf`, fail:"ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ URL.", title:"ĞŸÑ€ĞµĞ´Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ PDF", cancel:"ĞÑ‚Ğ¼ĞµĞ½Ğ°", retry:"ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€", hint:"ĞĞ° iPad Ğ¾Ñ‚Ñ€Ğ¸ÑĞ¾Ğ²ĞºĞ° Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ½ÑÑ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ. Ğ”ĞµÑ€Ğ¶Ğ¸Ñ‚Ğµ Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ Ğ½Ğ° Ğ¿ĞµÑ€ĞµĞ´Ğ½ĞµĞ¼ Ğ¿Ğ»Ğ°Ğ½Ğµ." },
      "ar": { lang:"Ø§Ù„Ù„ØºØ©", preview:"Ù…Ø¹Ø§ÙŠÙ†Ø©", idle:"Ù„Ø§ Ù…Ù„Ù Ù…Ø­Ù…Ù‘Ù„", loading:"Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦", showing:(l)=>`ÙŠÙØ¹Ø±Ø¶: â€${l}.pdf`, fail:"ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·.", title:"Ù…Ø¹Ø§ÙŠÙ†Ø© PDF", cancel:"Ø¥Ù„ØºØ§Ø¡", retry:"Ø¥Ø¹Ø§Ø¯Ø©", hint:"Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø§Ù„Ø¹Ø±Ø¶ ÙˆÙ‚ØªÙ‹Ø§ Ø¹Ù„Ù‰ iPad. Ø£Ø¨Ù‚Ù Ø§Ù„ØªØ¨ÙˆÙŠØ¨ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©." },
      "hi": { lang:"à¤­à¤¾à¤·à¤¾", preview:"à¤ªà¥‚à¤°à¥à¤µà¤¾à¤µà¤²à¥‹à¤•à¤¨", idle:"à¤•à¥‹à¤ˆ à¤«à¤¼à¤¾à¤‡à¤² à¤²à¥‹à¤¡ à¤¨à¤¹à¥€à¤‚", loading:"à¤²à¥‹à¤¡ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆâ€¦", showing:(l)=>`à¤¦à¤¿à¤–à¤¾ à¤°à¤¹à¤¾ à¤¹à¥ˆ: ${l}.pdf`, fail:"à¤²à¥‹à¤¡ à¤µà¤¿à¤«à¤²à¥¤ URL à¤œà¤¾à¤à¤šà¥‡à¤‚.", title:"PDF à¤ªà¥‚à¤°à¥à¤µà¤¾à¤µà¤²à¥‹à¤•à¤¨", cancel:"à¤°à¤¦à¥à¤¦", retry:"à¤«à¤¿à¤° à¤¸à¥‡", hint:"iPad à¤ªà¤° à¤°à¥‡à¤‚à¤¡à¤°à¤¿à¤‚à¤— à¤®à¥‡à¤‚ à¤¸à¤®à¤¯ à¤²à¤— à¤¸à¤•à¤¤à¤¾ à¤¹à¥ˆà¥¤ à¤Ÿà¥ˆà¤¬ à¤•à¥‹ à¤…à¤—à¥à¤°à¤­à¥‚à¤®à¤¿ à¤®à¥‡à¤‚ à¤°à¤–à¥‡à¤‚à¥¤" },
      "zh-CN": { lang:"è¯­è¨€", preview:"é¢„è§ˆ", idle:"æœªåŠ è½½æ–‡ä»¶", loading:"æ­£åœ¨åŠ è½½â€¦", showing:(l)=>`æ­£åœ¨æ˜¾ç¤ºï¼š${l}.pdf`, fail:"åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥é“¾æ¥ã€‚", title:"PDF é¢„è§ˆ", cancel:"å–æ¶ˆ", retry:"é‡è¯•", hint:"åœ¨ iPad ä¸Šæ¸²æŸ“å¯èƒ½è¾ƒæ…¢ã€‚è¯·ä¿æŒé¡µé¢å‰å°ã€‚"},
      "zh-TW": { lang:"èªè¨€", preview:"é è¦½", idle:"æœªè¼‰å…¥æª”æ¡ˆ", loading:"è¼‰å…¥ä¸­â€¦", showing:(l)=>`é¡¯ç¤ºä¸­ï¼š${l}.pdf`, fail:"è¼‰å…¥å¤±æ•—ã€‚è«‹æª¢æŸ¥é€£çµã€‚", title:"PDF é è¦½", cancel:"å–æ¶ˆ", retry:"é‡è©¦", hint:"åœ¨ iPad ä¸Šç¹ªè£½å¯èƒ½è¼ƒæ…¢ã€‚è«‹ä¿æŒåˆ†é åœ¨å‰æ™¯ã€‚" },
      "ko": { lang:"ì–¸ì–´", preview:"ë¯¸ë¦¬ë³´ê¸°", idle:"íŒŒì¼ ë¯¸ë¡œë“œ", loading:"ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦", showing:(l)=>`í‘œì‹œ ì¤‘: ${l}.pdf`, fail:"ë¡œë“œ ì‹¤íŒ¨. URL í™•ì¸.", title:"PDF ë¯¸ë¦¬ë³´ê¸°", cancel:"ì·¨ì†Œ", retry:"ë‹¤ì‹œ ì‹œë„", hint:"iPadì—ì„œ ë Œë”ë§ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íƒ­ì„ ì „ê²½ì— ë‘ì„¸ìš”." },
    };

    // init
    document.getElementById("preview-btn").addEventListener("click", handlePreview);
    document.getElementById("lang_selection").addEventListener("change", handleLangChange);
    document.getElementById("cancel-btn").addEventListener("click", cancelLoading);
    document.getElementById("retry-btn").addEventListener("click", handlePreview);
    document.addEventListener("keydown", (e)=>{ if(e.key==="Enter") handlePreview(); });
    initUI();

    // state
    let currentAbort = null;
    let currentBlobURL = null;

    // ===== functions =====
    function initUI(){
      applyI18n(getSelectedLang());
      setStatus(getMsg("idle"));
      setPreviewTitle();
      setHtmlLang(getSelectedLang());
      setHintVisibility(false);
    }

    function getSelectedLang(){
      return document.getElementById("lang_selection").value;
    }

    function buildUrl(lang){
      return `${BASE_URL}/${lang}.pdf`;
    }

    async function handlePreview(){
      clearError();
      setHintVisibility(isIOS());
      const lang = getSelectedLang();
      const url  = buildUrl(lang);

      // æ—¢å­˜ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ä¸­æ–­
      cancelLoading();

      setStatus(getMsg("loading"));
      showProgress(true);
      toggleActions({ cancel:true, retry:false });

      try{
        // é€²æ—ä»˜ãã§å–å¾— â†’ Blob URL ã«ã—ã¦åŸ‹ã‚è¾¼ã‚€ï¼ˆæç”»é–‹å§‹ã¯é…ã„ãŒè¦‹ãˆã‚‹é€²æ—ï¼‰
        const blob = await fetchWithProgress(url, onProgress);
        if(!blob) throw new Error("fetch failed");

        // æ—¢å­˜ã® blob URL ã‚’è§£æ”¾
        if(currentBlobURL){ URL.revokeObjectURL(currentBlobURL); }
        currentBlobURL = URL.createObjectURL(blob);

        // iOS ã§ã‚‚ iframe ã« blob ã¯è¡¨ç¤ºå¯èƒ½ï¼ˆæ™‚é–“ã¯ã‹ã‹ã‚‹ï¼‰
        document.getElementById("preview").src = currentBlobURL;
        setStatus(getMsg("showing")(lang));
        toggleActions({ cancel:false, retry:false });
      }catch(e){
        setStatus(getMsg("fail"));
        showError(getMsg("fail"));
        toggleActions({ cancel:false, retry:true });
      }finally{
        showProgress(false);
      }

      // é€²æ—è¡¨ç¤ºæ›´æ–°
      function onProgress(loaded, total){
        updateProgress(total ? Math.round((loaded/total)*100) : null);
      }
    }

    // é€²æ—ä»˜ã fetchï¼ˆReadableStream ã‚’åˆ©ç”¨ï¼‰
    async function fetchWithProgress(url, onProgress){
      try{
        currentAbort = new AbortController();
        const res = await fetch(url, { signal: currentAbort.signal, cache:"no-store" });
        if(!res.ok) return null;

        const total = Number(res.headers.get("Content-Length")) || 0;
        if(!res.body || !('getReader' in res.body)) {
          // ã‚¹ãƒˆãƒªãƒ¼ãƒ éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶: ãã®ã¾ã¾ Blob
          const blob = await res.blob();
          onProgress(total, total);
          return blob;
        }

        const reader = res.body.getReader();
        const chunks = [];
        let loaded = 0;
        while(true){
          const {done, value} = await reader.read();
          if(done) break;
          chunks.push(value);
          loaded += value.byteLength;
          onProgress(loaded, total);
        }
        return new Blob(chunks, { type:"application/pdf" });
      }catch(e){
        return null;
      }finally{
        currentAbort = null;
      }
    }

    function cancelLoading(){
      if(currentAbort){ currentAbort.abort(); currentAbort = null; }
      updateProgress(0);
      showProgress(false);
      toggleActions({ cancel:false, retry:true });
    }

    function toggleActions({cancel, retry}){
      document.getElementById(CANCEL_ID).style.display = cancel ? "inline-flex" : "none";
      document.getElementById(RETRY_ID).style.display  = retry  ? "inline-flex" : "none";
      document.getElementById(CANCEL_ID).textContent = getMsg("cancel");
      document.getElementById(RETRY_ID).textContent  = getMsg("retry");
    }

    function updateProgress(pct){
      const wrap = document.getElementById(PROG_WRAP_ID);
      const fill = document.getElementById(FILL_ID);
      const pctEl= document.getElementById(PCT_ID);
      if(pct == null){
        fill.style.width = "100%";
        fill.style.animation = "ind 1.2s linear infinite";
        pctEl.textContent = "--";
      }else{
        fill.style.animation = "none";
        fill.style.width = `${Math.min(100, Math.max(0, pct))}%`;
        pctEl.textContent = `${pct}%`;
      }
    }

    function showProgress(v){
      document.getElementById(PROG_WRAP_ID).style.display = v ? "flex" : "none";
    }

    function setHintVisibility(v){
      document.getElementById(HINT_ID).style.display = v ? "block" : "none";
      document.getElementById(HINT_ID).textContent = getMsg("hint");
    }

    function handleLangChange(){
      const lang = getSelectedLang();
      applyI18n(lang);
      setHtmlLang(lang);
      setStatus(getMsg("idle"));
    }

    function applyI18n(lang){
      const t = I18N[lang] || I18N.en;
      document.getElementById(LABEL_LANG_ID).textContent = t.lang;
      document.getElementById(PREVIEW_BTN_ID).textContent = t.preview;
      setPreviewTitle();
    }

    function getMsg(key){
      const lang = getSelectedLang();
      return (I18N[lang] || I18N.en)[key] || I18N.en[key];
    }

    function setPreviewTitle(){
      document.getElementById(PREVIEW_ID).title = getMsg("title");
    }

    function setStatus(text){
      document.getElementById(STATUS_ID).textContent = text;
    }

    function showError(msg){
      const el = document.getElementById(ERROR_ID);
      el.textContent = msg;
      el.style.display = "block";
    }

    function clearError(){
      document.getElementById(ERROR_ID).style.display = "none";
    }

    function isIOS(){
      const ua = navigator.userAgent || navigator.vendor || "";
      const iOS = /iPad|iPhone|iPod/.test(ua);
      const iPadOS13Plus = (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
      return iOS || iPadOS13Plus;
    }

    function setHtmlLang(lang){
      document.documentElement.lang = lang;
      document.documentElement.dir = "ltr";
    }
  </script>
</body>
</html>
